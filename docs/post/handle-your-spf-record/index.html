<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Get a handle on your SPF record | VAND3RLINDEN</title>
<meta name="keywords" content="">
<meta name="description" content="In this post, I will share my best practices for getting a handle on your SPF record.
Why it makes sense to have a good SPF procedure in place In a previous blog post, I explained the limitations of SPF, best practices and how it works with DKIM and DMARC. It is useful to have a good SPF procedure to avoid future problems, because if you exceed the DNS lookup limit of 10:">
<meta name="author" content="">
<link rel="canonical" href="https://vand3rlinden.com/post/handle-your-spf-record/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.9329d037bc79464b26647fb72e079cd738f5d2418b1df4da3b515db9e22cb4d9.css" integrity="sha256-kynQN7x5RksmZH&#43;3Lgec1zj10kGLHfTaO1FdueIstNk=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://vand3rlinden.com/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://vand3rlinden.com/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://vand3rlinden.com/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://vand3rlinden.com/apple-touch-icon.png">
<link rel="mask-icon" href="https://vand3rlinden.com/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:title" content="Get a handle on your SPF record" />
<meta property="og:description" content="In this post, I will share my best practices for getting a handle on your SPF record.
Why it makes sense to have a good SPF procedure in place In a previous blog post, I explained the limitations of SPF, best practices and how it works with DKIM and DMARC. It is useful to have a good SPF procedure to avoid future problems, because if you exceed the DNS lookup limit of 10:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://vand3rlinden.com/post/handle-your-spf-record/" />
<meta property="og:image" content="https://vand3rlinden.com/images/handle-your-spf-record/handle-your-spf-record-front.png" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-12-17T18:31:45+01:00" />
<meta property="article:modified_time" content="2023-12-17T18:31:45+01:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://vand3rlinden.com/images/handle-your-spf-record/handle-your-spf-record-front.png" />
<meta name="twitter:title" content="Get a handle on your SPF record"/>
<meta name="twitter:description" content="In this post, I will share my best practices for getting a handle on your SPF record.
Why it makes sense to have a good SPF procedure in place In a previous blog post, I explained the limitations of SPF, best practices and how it works with DKIM and DMARC. It is useful to have a good SPF procedure to avoid future problems, because if you exceed the DNS lookup limit of 10:"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://vand3rlinden.com/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Get a handle on your SPF record",
      "item": "https://vand3rlinden.com/post/handle-your-spf-record/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Get a handle on your SPF record",
  "name": "Get a handle on your SPF record",
  "description": "In this post, I will share my best practices for getting a handle on your SPF record.\nWhy it makes sense to have a good SPF procedure in place In a previous blog post, I explained the limitations of SPF, best practices and how it works with DKIM and DMARC. It is useful to have a good SPF procedure to avoid future problems, because if you exceed the DNS lookup limit of 10:",
  "keywords": [
    
  ],
  "articleBody": " In this post, I will share my best practices for getting a handle on your SPF record.\nWhy it makes sense to have a good SPF procedure in place In a previous blog post, I explained the limitations of SPF, best practices and how it works with DKIM and DMARC. It is useful to have a good SPF procedure to avoid future problems, because if you exceed the DNS lookup limit of 10:\nYour domain name is vulnerable to spoofing Your domain authentication or validation may fail Your emails will be undeliverable without any warning Around the globe you will find an answer to bypass the DNS lookup limit with SPF flattening. This approach converts hostnames to IP addresses, which don’t count in the DNS lookup count.\nThe dangers of SPF flattening The problem with flattening is that email service providers can change or add IP addresses without telling you. Then your SPF record is inaccurate, leading to email delivery problems (there are paid tools that can automate SPF flattening).\nSPF flattening makes it easier to forget entries that need to be removed (over-authorization).\nFrom a security perspective, over-authorization due to bloated SPF records is another way of saying “unnecessary entries in SPF records create attack surfaces”. If an adversary is able to break into (or simply rent) any piece of infrastructure that is listed in an SPF record, that adversary will be able to bypass your SPF and even DMARC to send DMARC compliant email.\nWhen you segment your vendors and email streams, you will find that there is no need for SPF flattening, because subdomain segmentation creates a new domain dedicated to a particular mail stream with its own 10 DNS lookups. Domains that move toward creating an SPF segmentation process will end up with better controls, a smaller attack surface, and limit the spillover effects of a potential cyber incident.\nSPF flattening attempts to work around the Too Many DNS Lookups error without addressing the underlying issues that caused the error in the first place. Avoiding SPF record flattening will help you get a handle on your SPF record.\nHow to get a handle on your SPF record Quick wins on how to handle your SPF record: Not using entries like a and mx, these mechanisms are often useless and probably should not be included in your SPF record (and other duplicate SPF mechanisms).\nWhere email is incapable of passing DMARC with SPF, configure DKIM for the P2 Sender domain on the sending email stream.\nFor the long term: Imagine your organization has an SPF record with 9 of the 10 allowed DNS lookups, such as:\nv=spf1 ip4:11.222.33.444 ip4:44.33.222.111 ip4:22.33.444.555 ip4:55.66.777.8 ip4:88.99.999.99 ip4:99.88.777.66 mx include:spf.protection.outlook.com include:_spf.app1.com include:_spf.app2.com include:_spf.app3.com include:_spf.app4.com -all Calculation of DNS lookups:\nLook up Count include:spf.protection.outlook.com 2 DNS Look Ups include:_spf.app1.com 1 DNS Look Ups include:_spf.app2.com 1 DNS Look Ups include:_spf.app3.com 2 DNS Look Ups include:_spf.app4.com 2 DNS Look Ups mx (your MX record) 1 DNS Look Ups Total: 9 DNS Look Ups To streamline this process, it’s essential to segment your email streams effectively.\nIn today’s world, we’re surrounded by numerous SaaS applications that use our primary domain for email correspondence. But is it really necessary for these applications to send through your primary domain when they could just as easily use a separate subdomain with its own SPF (TXT) record?\nConsider the newsletter scenario. Does it really need to send emails on behalf of your primary domain, or could it just as effectively send them from an address like noreply@news.yourdomain.com?\nNOTE: Some SaaS applications, such as SendGrid, allow SPF to pass through a subdomain as the P1 sender, while still allowing you to use your root domain as the P2 sender. Similarly, when utilizing sendmail in Unix, you have the flexibility to configure a subdomain as the P1 sender while maintaining the ability to send emails using your root domain. This approach complies with DMARC standards, and in this setup, DKIM validation for the P2 sender is not necessary, although it is always wise to set up DKIM for enhanced security measures.\nCut your SPF record With the above in mind, which SaaS applications need to send on behalf of your primary domain, like Microsoft 365, and which don’t. Like your newsletter service or an internal application.\nFor example:\nLook up Outcome include:spf.protection.outlook.com Need to send over yourdomain.com include:_spf.app1.com Need to send over yourdomain.com include:_spf.app2.com Need to send over yourdomain.com include:_spf.app3.com (delete) Can send over app1.yourdomain.com include:_spf.app4.com (delete) Can send over news.yourdomain.com mx (delete)* Duplicate mechanisms *when using Microsoft 365, the MX endpoint IP is already listed in include:spf.protection.outlook.com\nIf you look at the example above, we have 4 DNS lookups left, so we cleaned 5 DNS lookups, good job! But what about the IP addresses in the SPF record? IP addresses don’t cost any DNS lookups because we’re not talking to DNS. One disadvantage of using IP addresses in your SPF record is that it will result in an unmanageable and too long record. Yes, we can add a new include with the cost of 1 DNS lookup, for example include:_spf.yourdomain.com with a new SPF (TXT) record like this:\nSPF for yourdomain.com:\nv=spf1 include:_spf.yourdomain.com -all SPF for _spf.yourdomain.com:\nv=spf1 ip4:11.222.33.444 ip4:44.33.222.111 ip4:22.33.444.555 ip4:55.66.777.8 ip4:88.99.999.99 ip4:99.88.777.66 -all But without being afraid of needing another DNS lookup when the _spf.yourdomain.com include reaches its limit of two strings of 255 characters. You can start by using a SPF macro instead. This macro also costs 1 DNS lookup, but you can add an unlimited number of IP addresses to it by creating a separate A record for each /32 IP address.\nUsing an SPF macro for your IP addresses In the SPF record for yourdomain.com, add the following DNS lookup: exists:%{i}._spf.yourdomain.com Now, for each IP address, we will create an A record that is not publicly routable (such as to 127.0.0.2) and a TXT record. The TXT record is set to list the source of the IP address and can have any value, which is optional to use. Host Type Value 11.222.33.444._spf.yourdomain.com A 127.0.0.2 11.222.33.444._spf.yourdomain.com TXT Internal You can repeat this for an unlimited number of IP addresses.\nIf you’re not comfortable with setting a source in public DNS, this option is optional for the above SPF macro. In my opinion, there should be no security concerns if you use a minimal listed source, such as vendor name or internal. For the internal value (if you are using an Azure VM), you can check in Azure which PIP is bound to a NIC for example. Also, the IP addresses are not directly visible using this SPF macro, as you can see in the SPF record from step 1. So the direct hostname is not easy to guess, and the purpose of these systems is probably already easy to identify in other ways, such as an Nmap scan for open ports.\nIn summary The main SPF record is cleaned up with 5 DNS lookups, this with segment your vendors and email streams with subdomains. We deleted the mx DNS lookup because of a duplicate mechanism. We have a good and secure way to add an unlimited number of IP addresses to the SPF record using an SPF macro. The cleaned SPF record has only 4 DNS lookups instead of 9 DNS lookups before cleaning:\nv=spf1 exists:%{i}._spf.yourdomain.com include:spf.protection.outlook.com include:_spf.app1.com include:_spf.app2.com -all Lastly For the future of your SPF record, add IP addresses to your main SPF record using the SPF macro we set up, and choose carefully if a SaaS application should be sent through a subdomain instead of your main domain.\nReference dmarcian SPF best practices Concluding the Experiment: SPF Flattening ",
  "wordCount" : "1274",
  "inLanguage": "en",
  "image":"https://vand3rlinden.com/images/handle-your-spf-record/handle-your-spf-record-front.png","datePublished": "2023-12-17T18:31:45+01:00",
  "dateModified": "2023-12-17T18:31:45+01:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://vand3rlinden.com/post/handle-your-spf-record/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "VAND3RLINDEN",
    "logo": {
      "@type": "ImageObject",
      "url": "https://vand3rlinden.com/favicon.ico"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://vand3rlinden.com" accesskey="h" title="VAND3RLINDEN (Alt + H)">VAND3RLINDEN</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://vand3rlinden.com/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://vand3rlinden.com/post/" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://vand3rlinden.com">Home</a>&nbsp;»&nbsp;<a href="https://vand3rlinden.com/post/">Posts</a></div>
    <h1 class="post-title">
      Get a handle on your SPF record
    </h1>
    <div class="post-meta"><span title='2023-12-17 18:31:45 +0100 CET'>December 17, 2023</span>&nbsp;·&nbsp;6 min

</div>
  </header> 
<figure class="entry-cover"><img loading="lazy" src="https://vand3rlinden.com/images/handle-your-spf-record/handle-your-spf-record-front.png" alt="">
        
</figure>
  <div class="post-content"><blockquote>
<p><em>In this post, I will share my best practices for getting a handle on your SPF record.</em></p>
</blockquote>
<h2 id="why-it-makes-sense-to-have-a-good-spf-procedure-in-place">Why it makes sense to have a good SPF procedure in place<a hidden class="anchor" aria-hidden="true" href="#why-it-makes-sense-to-have-a-good-spf-procedure-in-place">#</a></h2>
<p>In a previous <a href="https://vand3rlinden.com/post/spf-dkim-dmarc-explanation/">blog post</a>, I explained the limitations of SPF, best practices and how it works with DKIM and DMARC. It is useful to have a good SPF procedure to avoid future problems, because if you exceed the DNS lookup limit of 10:</p>
<ul>
<li>Your domain name is vulnerable to spoofing</li>
<li>Your domain authentication or validation may fail</li>
<li>Your emails will be undeliverable without any warning</li>
</ul>
<p>Around the globe you will find an answer to bypass the DNS lookup limit with <em><strong>SPF flattening</strong></em>. This approach converts hostnames to IP addresses, which don’t count in the DNS lookup count.</p>
<h2 id="the-dangers-of-spf-flattening">The dangers of SPF flattening<a hidden class="anchor" aria-hidden="true" href="#the-dangers-of-spf-flattening">#</a></h2>
<ul>
<li>
<p>The problem with flattening is that email service providers can change or add IP addresses without telling you. Then your SPF record is inaccurate, leading to email delivery problems (there are paid tools that can automate SPF flattening).</p>
</li>
<li>
<p>SPF flattening makes it easier to forget entries that need to be removed (over-authorization).</p>
</li>
</ul>
<p>From a security perspective, over-authorization due to bloated SPF records is another way of saying “unnecessary entries in SPF records create attack surfaces”. If an adversary is able to break into (or simply rent) any piece of infrastructure that is listed in an SPF record, that adversary will be able to bypass your SPF and even DMARC to send DMARC compliant email.</p>
<p>When you segment your vendors and email streams, you will find that there is no need for SPF flattening, because subdomain segmentation creates a new domain dedicated to a particular mail stream with its own 10 DNS lookups. Domains that move toward creating an SPF segmentation process will end up with better controls, a smaller attack surface, and limit the spillover effects of a potential cyber incident.</p>
<p>SPF flattening attempts to work around the <em><strong>Too Many DNS Lookups</strong></em> error without addressing the underlying issues that caused the error in the first place. Avoiding SPF record flattening will help you get a handle on your SPF record.</p>
<h2 id="how-to-get-a-handle-on-your-spf-record">How to get a handle on your SPF record<a hidden class="anchor" aria-hidden="true" href="#how-to-get-a-handle-on-your-spf-record">#</a></h2>
<h4 id="quick-wins-on-how-to-handle-your-spf-record">Quick wins on how to handle your SPF record:<a hidden class="anchor" aria-hidden="true" href="#quick-wins-on-how-to-handle-your-spf-record">#</a></h4>
<ul>
<li>
<p>Not using entries like <code>a</code> and <code>mx</code>, these mechanisms are often useless and probably should not be included in your SPF record (and other duplicate SPF mechanisms).</p>
</li>
<li>
<p>Where email is incapable of passing DMARC with SPF, configure DKIM for the P2 Sender domain on the sending email stream.</p>
</li>
</ul>
<h4 id="for-the-long-term">For the long term:<a hidden class="anchor" aria-hidden="true" href="#for-the-long-term">#</a></h4>
<p>Imagine your organization has an SPF record with 9 of the 10 allowed DNS lookups, such as:</p>
<pre tabindex="0"><code>v=spf1 ip4:11.222.33.444 ip4:44.33.222.111 ip4:22.33.444.555 ip4:55.66.777.8 ip4:88.99.999.99 ip4:99.88.777.66 mx include:spf.protection.outlook.com include:_spf.app1.com include:_spf.app2.com include:_spf.app3.com include:_spf.app4.com -all
</code></pre><p>Calculation of DNS lookups:</p>
<table>
<thead>
<tr>
<th>Look up</th>
<th>Count</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>include:spf.protection.outlook.com</code></td>
<td>2 DNS Look Ups</td>
</tr>
<tr>
<td><code>include:_spf.app1.com</code></td>
<td>1 DNS Look Ups</td>
</tr>
<tr>
<td><code>include:_spf.app2.com</code></td>
<td>1 DNS Look Ups</td>
</tr>
<tr>
<td><code>include:_spf.app3.com</code></td>
<td>2 DNS Look Ups</td>
</tr>
<tr>
<td><code>include:_spf.app4.com</code></td>
<td>2 DNS Look Ups</td>
</tr>
<tr>
<td><code>mx</code> (your MX record)</td>
<td>1 DNS Look Ups</td>
</tr>
<tr>
<td>Total:</td>
<td>9 DNS Look Ups</td>
</tr>
</tbody>
</table>
<p>To streamline this process, it&rsquo;s essential to segment your email streams effectively.</p>
<p>In today&rsquo;s world, we&rsquo;re surrounded by numerous SaaS applications that use our primary domain for email correspondence. But is it really necessary for these applications to send through your primary domain when they could just as easily use a separate subdomain with its own SPF (TXT) record?</p>
<p>Consider the newsletter scenario. Does it really need to send emails on behalf of your primary domain, or could it just as effectively send them from an address like <a href="mailto:noreply@news.yourdomain.com">noreply@news.yourdomain.com</a>?</p>
<blockquote>
<p><em><strong>NOTE</strong></em>: Some SaaS applications, such as SendGrid, allow SPF to pass through a subdomain as the P1 sender, while still allowing you to use your root domain as the P2 sender. Similarly, when utilizing sendmail in Unix, you have the flexibility to configure a subdomain as the P1 sender while maintaining the ability to send emails using your root domain. This approach complies with DMARC standards, and in this setup, DKIM validation for the P2 sender is not necessary, although it is always wise to set up DKIM for enhanced security measures.</p>
</blockquote>
<h2 id="cut-your-spf-record">Cut your SPF record<a hidden class="anchor" aria-hidden="true" href="#cut-your-spf-record">#</a></h2>
<p>With the above in mind, which SaaS applications <em><strong>need</strong></em> to send on behalf of your primary domain, like Microsoft 365, and which <em><strong>don’t</strong></em>. Like your newsletter service or an internal application.</p>
<p>For example:</p>
<table>
<thead>
<tr>
<th>Look up</th>
<th>Outcome</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>include:spf.protection.outlook.com</code></td>
<td>Need to send over yourdomain.com</td>
</tr>
<tr>
<td><code>include:_spf.app1.com</code></td>
<td>Need to send over yourdomain.com</td>
</tr>
<tr>
<td><code>include:_spf.app2.com</code></td>
<td>Need to send over yourdomain.com</td>
</tr>
<tr>
<td><code>include:_spf.app3.com</code> (delete)</td>
<td>Can send over app1.yourdomain.com</td>
</tr>
<tr>
<td><code>include:_spf.app4.com</code> (delete)</td>
<td>Can send over news.yourdomain.com</td>
</tr>
<tr>
<td><code>mx</code> (delete)*</td>
<td>Duplicate mechanisms</td>
</tr>
</tbody>
</table>
<blockquote>
<p>*when using Microsoft 365, the MX endpoint IP is already listed in <em>include:spf.protection.outlook.com</em></p>
</blockquote>
<p>If you look at the example above, we have <em><strong>4 DNS lookups left</strong></em>, so we cleaned <em><strong>5 DNS lookups</strong></em>, good job! But what about the IP addresses in the SPF record? IP addresses don’t cost any DNS lookups because we’re not talking to DNS. One disadvantage of using IP addresses in your SPF record is that it will result in an unmanageable and too long record. Yes, we can add a new include with the cost of 1 DNS lookup, for example <code>include:_spf.yourdomain.com</code> with a new SPF (TXT) record like this:</p>
<p>SPF for <code>yourdomain.com</code>:</p>
<pre tabindex="0"><code>v=spf1 include:_spf.yourdomain.com -all 
</code></pre><p>SPF for <code>_spf.yourdomain.com</code>:</p>
<pre tabindex="0"><code>v=spf1 ip4:11.222.33.444 ip4:44.33.222.111 ip4:22.33.444.555 ip4:55.66.777.8 ip4:88.99.999.99 ip4:99.88.777.66 -all
</code></pre><p>But without being afraid of needing another DNS lookup when the <code>_spf.yourdomain.com</code> include reaches its limit of two strings of 255 characters. You can start by using a SPF macro instead. This macro also costs 1 DNS lookup, but you can add an unlimited number of IP addresses to it by creating a separate A record for each <code>/32</code> IP address.</p>
<h2 id="using-an-spf-macro-for-your-ip-addresses">Using an SPF macro for your IP addresses<a hidden class="anchor" aria-hidden="true" href="#using-an-spf-macro-for-your-ip-addresses">#</a></h2>
<ol>
<li>In the SPF record for <code>yourdomain.com</code>, add the following DNS lookup:</li>
</ol>
<pre tabindex="0"><code>exists:%{i}._spf.yourdomain.com
</code></pre><ol start="2">
<li>Now, for each IP address, we will create an <code>A</code> record that is not publicly routable (such as to 127.0.0.2) and a <code>TXT</code> record. The <code>TXT</code> record is set to list the source of the IP address and can have any value, which is <em><strong>optional</strong></em> to use.</li>
</ol>
<table>
<thead>
<tr>
<th>Host</th>
<th>Type</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>11.222.33.444._spf.yourdomain.com</code></td>
<td><code>A</code></td>
<td><code>127.0.0.2</code></td>
</tr>
<tr>
<td><code>11.222.33.444._spf.yourdomain.com</code></td>
<td><code>TXT</code></td>
<td><code>Internal</code></td>
</tr>
</tbody>
</table>
<p>You can repeat this for an unlimited number of IP addresses.</p>
<p>If you’re not comfortable with setting a source in public DNS, this option is <em><strong>optional</strong></em> for the above SPF macro. In my opinion, there should be no security concerns if you use a minimal listed source, such as <em>vendor name</em> or <em>internal</em>. For the internal value (if you are using an Azure VM), you can check in Azure which PIP is bound to a NIC for example. Also, the IP addresses are not directly visible using this SPF macro, as you can see in the SPF record from step 1. So the direct hostname is not easy to guess, and the purpose of these systems is probably already easy to identify in other ways, such as an Nmap scan for open ports.</p>
<h2 id="in-summary">In summary<a hidden class="anchor" aria-hidden="true" href="#in-summary">#</a></h2>
<ol>
<li>The main SPF record is cleaned up with 5 DNS lookups, this with segment your vendors and email streams with subdomains.</li>
<li>We deleted the <code>mx</code> DNS lookup because of a duplicate mechanism.</li>
<li>We have a good and secure way to add an unlimited number of IP addresses to the SPF record using an SPF macro.</li>
</ol>
<p>The cleaned SPF record has only 4 DNS lookups instead of 9 DNS lookups before cleaning:</p>
<pre tabindex="0"><code>v=spf1 exists:%{i}._spf.yourdomain.com include:spf.protection.outlook.com include:_spf.app1.com include:_spf.app2.com -all
</code></pre><h2 id="lastly">Lastly<a hidden class="anchor" aria-hidden="true" href="#lastly">#</a></h2>
<p>For the future of your SPF record, add IP addresses to your main SPF record using the SPF macro we set up, and choose carefully if a SaaS application should be sent through a subdomain instead of your main domain.</p>
<h2 id="reference">Reference<a hidden class="anchor" aria-hidden="true" href="#reference">#</a></h2>
<ul>
<li><a href="https://dmarcian.com/spf-best-practices/">dmarcian SPF best practices</a></li>
<li><a href="https://dmarcian.com/spf-flattening/">Concluding the Experiment: SPF Flattening</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://vand3rlinden.com/post/mdo-anti-spam-policies/">
    <span class="title">« Prev</span>
    <br>
    <span>Microsoft Defender for Office 365: Anti-spam policies</span>
  </a>
  <a class="next" href="https://vand3rlinden.com/post/purview-data-loss-prevention/">
    <span class="title">Next »</span>
    <br>
    <span>Microsoft Purview: Configuring a Data Loss Prevention Policy</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Get a handle on your SPF record on x"
            href="https://x.com/intent/tweet/?text=Get%20a%20handle%20on%20your%20SPF%20record&amp;url=https%3a%2f%2fvand3rlinden.com%2fpost%2fhandle-your-spf-record%2f&amp;hashtags=">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Get a handle on your SPF record on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fvand3rlinden.com%2fpost%2fhandle-your-spf-record%2f&amp;title=Get%20a%20handle%20on%20your%20SPF%20record&amp;summary=Get%20a%20handle%20on%20your%20SPF%20record&amp;source=https%3a%2f%2fvand3rlinden.com%2fpost%2fhandle-your-spf-record%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Get a handle on your SPF record on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2fvand3rlinden.com%2fpost%2fhandle-your-spf-record%2f&title=Get%20a%20handle%20on%20your%20SPF%20record">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Get a handle on your SPF record on facebook"
            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fvand3rlinden.com%2fpost%2fhandle-your-spf-record%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Get a handle on your SPF record on whatsapp"
            href="https://api.whatsapp.com/send?text=Get%20a%20handle%20on%20your%20SPF%20record%20-%20https%3a%2f%2fvand3rlinden.com%2fpost%2fhandle-your-spf-record%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Get a handle on your SPF record on telegram"
            href="https://telegram.me/share/url?text=Get%20a%20handle%20on%20your%20SPF%20record&amp;url=https%3a%2f%2fvand3rlinden.com%2fpost%2fhandle-your-spf-record%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Get a handle on your SPF record on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=Get%20a%20handle%20on%20your%20SPF%20record&u=https%3a%2f%2fvand3rlinden.com%2fpost%2fhandle-your-spf-record%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://vand3rlinden.com">VAND3RLINDEN</a></span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
